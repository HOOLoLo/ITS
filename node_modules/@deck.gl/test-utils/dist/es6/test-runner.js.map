{"version":3,"sources":["../../src/test-runner.js"],"names":["Deck","MapView","GL_VENDOR","DEFAULT_DECK_PROPS","Object","assign","defaultProps","id","width","height","style","position","left","top","views","useDevicePixels","debug","DEFAULT_TEST_OPTIONS","onTestStart","testCase","console","log","name","onTestPass","onTestFail","timeout","DEFAULT_TEST_CASE","TestRunner","constructor","props","isRunning","_testCases","_testCaseData","isHeadless","Boolean","window","browserTestDriver_isHeadless","testOptions","defaultTestCase","add","testCases","Array","isArray","push","run","options","Promise","resolve","reject","deck","onWebGLInitialized","_onWebGLInitialized","bind","onLoad","_currentTestCase","then","promise","forEach","_runTest","catch","error","_fail","message","finally","finalize","initTestCase","key","assert","_next","_pass","result","gl","vendorMasked","getParameter","ext","getExtension","vendorUnmasked","UNMASKED_VENDOR_WEBGL","gpuVendor","isDone","timeoutId","done","clearTimeout","setTimeout","runTestCase"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* global window, console */\n/* eslint-disable no-console */\nimport {Deck, MapView} from '@deck.gl/core';\n\nconst GL_VENDOR = 0x1f00;\n\nconst DEFAULT_DECK_PROPS = Object.assign({}, Deck.defaultProps, {\n  id: 'deckgl-render-test',\n  width: 800,\n  height: 450,\n  style: {position: 'absolute', left: '0px', top: '0px'},\n  views: [new MapView()],\n  useDevicePixels: false,\n  debug: true\n});\n\nconst DEFAULT_TEST_OPTIONS = {\n  // test lifecycle callback\n  onTestStart: testCase => console.log(`# ${testCase.name}`),\n  onTestPass: testCase => console.log(`ok ${testCase.name} passed`),\n  onTestFail: testCase => console.log(`not ok ${testCase.name} failed`),\n\n  // milliseconds to wait for each test case before aborting\n  timeout: 2000\n};\n\nconst DEFAULT_TEST_CASE = {\n  name: 'Unnamed test'\n};\n\nexport default class TestRunner {\n  /**\n   * props\n   *   Deck props\n   */\n  constructor(props = {}) {\n    this.props = Object.assign({}, DEFAULT_DECK_PROPS, props);\n\n    this.isRunning = false;\n    this._testCases = [];\n    this._testCaseData = null;\n\n    this.isHeadless = Boolean(window.browserTestDriver_isHeadless);\n\n    this.testOptions = Object.assign({}, DEFAULT_TEST_OPTIONS);\n  }\n\n  get defaultTestCase() {\n    return DEFAULT_TEST_CASE;\n  }\n\n  /**\n   * Add testCase(s)\n   */\n  add(testCases) {\n    if (!Array.isArray(testCases)) {\n      testCases = [testCases];\n    }\n    for (const testCase of testCases) {\n      this._testCases.push(testCase);\n    }\n    return this;\n  }\n\n  /**\n   * Returns a promise that resolves when all the test cases are done\n   */\n  run(options = {}) {\n    Object.assign(this.testOptions, options);\n\n    return new Promise((resolve, reject) => {\n      this.deck = new Deck(\n        Object.assign({}, this.props, {\n          onWebGLInitialized: this._onWebGLInitialized.bind(this),\n          onLoad: resolve\n        })\n      );\n\n      this.isRunning = true;\n      this._currentTestCase = null;\n    })\n      .then(() => {\n        let promise = Promise.resolve();\n        // chain test case promises\n        this._testCases.forEach(testCase => {\n          promise = promise.then(() => this._runTest(testCase));\n        });\n        return promise;\n      })\n      .catch(error => {\n        this._fail({error: error.message});\n      })\n      .finally(() => {\n        this.deck.finalize();\n        this.deck = null;\n      });\n  }\n\n  /* Lifecycle methods for subclassing */\n\n  initTestCase(testCase) {\n    for (const key in this.defaultTestCase) {\n      if (!(key in testCase)) {\n        testCase[key] = this.defaultTestCase[key];\n      }\n    }\n    this.testOptions.onTestStart(testCase);\n  }\n\n  assert(testCase) {\n    this.onTestPass(testCase);\n    this._next();\n  }\n\n  /* Utilities */\n\n  _pass(result) {\n    this.testOptions.onTestPass(this._currentTestCase, result);\n  }\n\n  _fail(result) {\n    this.testOptions.onTestFail(this._currentTestCase, result);\n  }\n\n  /* Private Methods */\n\n  _onWebGLInitialized(gl) {\n    const vendorMasked = gl.getParameter(GL_VENDOR);\n    const ext = gl.getExtension('WEBGL_debug_renderer_info');\n    const vendorUnmasked = ext && gl.getParameter(ext.UNMASKED_VENDOR_WEBGL || GL_VENDOR);\n    this.gpuVendor = vendorUnmasked || vendorMasked;\n  }\n\n  _runTest(testCase) {\n    return new Promise((resolve, reject) => {\n      this._currentTestCase = testCase;\n      this._next = resolve;\n\n      // normalize test case\n      this.initTestCase(testCase);\n\n      let isDone = false;\n      let timeoutId = null;\n      const done = () => {\n        if (!isDone) {\n          isDone = true;\n          window.clearTimeout(timeoutId);\n          this.assert(testCase);\n        }\n      };\n\n      timeoutId = window.setTimeout(done, testCase.timeout || this.testOptions.timeout);\n\n      this.runTestCase(testCase, done);\n    });\n  }\n}\n"],"file":"test-runner.js"}