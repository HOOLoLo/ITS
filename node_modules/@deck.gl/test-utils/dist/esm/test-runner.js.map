{"version":3,"sources":["../../src/test-runner.js"],"names":["Deck","MapView","GL_VENDOR","DEFAULT_DECK_PROPS","Object","assign","defaultProps","id","width","height","style","position","left","top","views","useDevicePixels","debug","DEFAULT_TEST_OPTIONS","onTestStart","testCase","console","log","name","onTestPass","onTestFail","timeout","DEFAULT_TEST_CASE","TestRunner","props","isRunning","_testCases","_testCaseData","isHeadless","Boolean","window","browserTestDriver_isHeadless","testOptions","testCases","Array","isArray","push","options","Promise","resolve","reject","deck","onWebGLInitialized","_onWebGLInitialized","bind","onLoad","_currentTestCase","then","promise","forEach","_runTest","error","_fail","message","finalize","key","defaultTestCase","_next","result","gl","vendorMasked","getParameter","ext","getExtension","vendorUnmasked","UNMASKED_VENDOR_WEBGL","gpuVendor","initTestCase","isDone","timeoutId","done","clearTimeout","assert","setTimeout","runTestCase"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* global window, console */\n/* eslint-disable no-console */\nimport {Deck, MapView} from '@deck.gl/core';\n\nconst GL_VENDOR = 0x1f00;\n\nconst DEFAULT_DECK_PROPS = Object.assign({}, Deck.defaultProps, {\n  id: 'deckgl-render-test',\n  width: 800,\n  height: 450,\n  style: {position: 'absolute', left: '0px', top: '0px'},\n  views: [new MapView()],\n  useDevicePixels: false,\n  debug: true\n});\n\nconst DEFAULT_TEST_OPTIONS = {\n  // test lifecycle callback\n  onTestStart: testCase => console.log(`# ${testCase.name}`),\n  onTestPass: testCase => console.log(`ok ${testCase.name} passed`),\n  onTestFail: testCase => console.log(`not ok ${testCase.name} failed`),\n\n  // milliseconds to wait for each test case before aborting\n  timeout: 2000\n};\n\nconst DEFAULT_TEST_CASE = {\n  name: 'Unnamed test'\n};\n\nexport default class TestRunner {\n  /**\n   * props\n   *   Deck props\n   */\n  constructor(props = {}) {\n    this.props = Object.assign({}, DEFAULT_DECK_PROPS, props);\n\n    this.isRunning = false;\n    this._testCases = [];\n    this._testCaseData = null;\n\n    this.isHeadless = Boolean(window.browserTestDriver_isHeadless);\n\n    this.testOptions = Object.assign({}, DEFAULT_TEST_OPTIONS);\n  }\n\n  get defaultTestCase() {\n    return DEFAULT_TEST_CASE;\n  }\n\n  /**\n   * Add testCase(s)\n   */\n  add(testCases) {\n    if (!Array.isArray(testCases)) {\n      testCases = [testCases];\n    }\n    for (const testCase of testCases) {\n      this._testCases.push(testCase);\n    }\n    return this;\n  }\n\n  /**\n   * Returns a promise that resolves when all the test cases are done\n   */\n  run(options = {}) {\n    Object.assign(this.testOptions, options);\n\n    return new Promise((resolve, reject) => {\n      this.deck = new Deck(\n        Object.assign({}, this.props, {\n          onWebGLInitialized: this._onWebGLInitialized.bind(this),\n          onLoad: resolve\n        })\n      );\n\n      this.isRunning = true;\n      this._currentTestCase = null;\n    })\n      .then(() => {\n        let promise = Promise.resolve();\n        // chain test case promises\n        this._testCases.forEach(testCase => {\n          promise = promise.then(() => this._runTest(testCase));\n        });\n        return promise;\n      })\n      .catch(error => {\n        this._fail({error: error.message});\n      })\n      .finally(() => {\n        this.deck.finalize();\n        this.deck = null;\n      });\n  }\n\n  /* Lifecycle methods for subclassing */\n\n  initTestCase(testCase) {\n    for (const key in this.defaultTestCase) {\n      if (!(key in testCase)) {\n        testCase[key] = this.defaultTestCase[key];\n      }\n    }\n    this.testOptions.onTestStart(testCase);\n  }\n\n  assert(testCase) {\n    this.onTestPass(testCase);\n    this._next();\n  }\n\n  /* Utilities */\n\n  _pass(result) {\n    this.testOptions.onTestPass(this._currentTestCase, result);\n  }\n\n  _fail(result) {\n    this.testOptions.onTestFail(this._currentTestCase, result);\n  }\n\n  /* Private Methods */\n\n  _onWebGLInitialized(gl) {\n    const vendorMasked = gl.getParameter(GL_VENDOR);\n    const ext = gl.getExtension('WEBGL_debug_renderer_info');\n    const vendorUnmasked = ext && gl.getParameter(ext.UNMASKED_VENDOR_WEBGL || GL_VENDOR);\n    this.gpuVendor = vendorUnmasked || vendorMasked;\n  }\n\n  _runTest(testCase) {\n    return new Promise((resolve, reject) => {\n      this._currentTestCase = testCase;\n      this._next = resolve;\n\n      // normalize test case\n      this.initTestCase(testCase);\n\n      let isDone = false;\n      let timeoutId = null;\n      const done = () => {\n        if (!isDone) {\n          isDone = true;\n          window.clearTimeout(timeoutId);\n          this.assert(testCase);\n        }\n      };\n\n      timeoutId = window.setTimeout(done, testCase.timeout || this.testOptions.timeout);\n\n      this.runTestCase(testCase, done);\n    });\n  }\n}\n"],"file":"test-runner.js"}